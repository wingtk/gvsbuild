From faf1f1e703e721c1ab1e905ae29a862713bb8974 Mon Sep 17 00:00:00 2001
From: Ignacio Casal Quinteiro <icq@gnome.org>
Date: Tue, 27 Oct 2015 08:45:30 +0100
Subject: [PATCH 3/3] Properly handle the visibility of the methods

https://bugzilla.gnome.org/show_bug.cgi?id=757146
---
 configure.ac                  |  33 +++
 libsoup/Makefile.am           |  24 +-
 libsoup/libsoup-2.4.sym       | 567 ------------------------------------------
 libsoup/libsoup-gnome-2.4.sym |   5 -
 4 files changed, 39 insertions(+), 590 deletions(-)
 delete mode 100644 libsoup/libsoup-2.4.sym
 delete mode 100644 libsoup/libsoup-gnome-2.4.sym

diff --git a/configure.ac b/configure.ac
index eac02db..f9e258e 100644
--- a/configure.ac
+++ b/configure.ac
@@ -336,6 +336,39 @@ if test "$GCC" = "yes" -a "$set_more_warnings" != "no"; then
 		-Werror=declaration-after-statement"
 fi
 
+##################################################
+# Visibility handling
+##################################################
+
+SOUP_HIDDEN_VISIBILITY_CFLAGS=""
+case "$host" in
+    *-*-mingw*)
+        dnl on mingw32 we do -fvisibility=hidden and __declspec(dllexport)
+        AC_DEFINE([_SOUP_EXTERN], [__attribute__((visibility("default"))) __declspec(dllexport) extern],
+                  [defines how to decorate public symbols while building])
+        SOUP_HIDDEN_VISIBILITY_CFLAGS="-fvisibility=hidden"
+        ;;
+    *)
+        dnl on other compilers, check if we can do -fvisibility=hidden
+        SAVED_CFLAGS="${CFLAGS}"
+        CFLAGS="-fvisibility=hidden"
+        AC_MSG_CHECKING([for -fvisibility=hidden compiler flag])
+        AC_TRY_COMPILE([], [int main (void) { return 0; }],
+                       AC_MSG_RESULT(yes)
+                       enable_fvisibility_hidden=yes,
+                       AC_MSG_RESULT(no)
+                       enable_fvisibility_hidden=no)
+        CFLAGS="${SAVED_CFLAGS}"
+
+        AS_IF([test "${enable_fvisibility_hidden}" = "yes"], [
+            AC_DEFINE([_SOUP_EXTERN], [__attribute__((visibility("default"))) extern],
+                      [defines how to decorate public symbols while building])
+            SOUP_HIDDEN_VISIBILITY_CFLAGS="-fvisibility=hidden"
+        ])
+        ;;
+esac
+AC_SUBST(SOUP_HIDDEN_VISIBILITY_CFLAGS)
+
 dnl *************************
 dnl *** Output Everything ***
 dnl *************************
diff --git a/libsoup/Makefile.am b/libsoup/Makefile.am
index 345bd3e..9a077b5 100644
--- a/libsoup/Makefile.am
+++ b/libsoup/Makefile.am
@@ -86,14 +86,14 @@ nodist_libsoupinclude_HEADERS =	\
 
 lib_LTLIBRARIES = libsoup-2.4.la
 
+libsoup_2_4_la_CFLAGS = $(AM_CFLAGS) $(SOUP_HIDDEN_VISIBILITY_CFLAGS)
+
 libsoup_2_4_la_LDFLAGS =	\
 	-version-info $(SOUP_CURRENT):$(SOUP_REVISION):$(SOUP_AGE) \
 	-no-undefined \
-	-export-symbols $(srcdir)/libsoup-2.4.sym \
+	-export-dynamic \
 	$(CODE_COVERAGE_LDFLAGS)
 
-EXTRA_DIST += libsoup-2.4.sym
-
 libsoup_2_4_la_LIBADD =			\
 	$(GLIB_LIBS)			\
 	$(LIBWS2_32)			\
@@ -221,12 +221,12 @@ libsoupgnomeinclude_HEADERS =	\
 
 lib_LTLIBRARIES += libsoup-gnome-2.4.la
 
+libsoup_gnome_2_4_la_CFLAGS = $(AM_CFLAGS) $(SOUP_HIDDEN_VISIBILITY_CFLAGS)
+
 libsoup_gnome_2_4_la_LDFLAGS =	\
 	-version-info $(SOUP_CURRENT):$(SOUP_REVISION):$(SOUP_AGE) \
 	-no-undefined \
-	-export-symbols $(srcdir)/libsoup-gnome-2.4.sym
-
-EXTRA_DIST += libsoup-gnome-2.4.sym
+	-export-dynamic
 
 libsoup_gnome_2_4_la_LIBADD =		\
 	libsoup-2.4.la			\
@@ -322,15 +322,3 @@ typelib_DATA = $(INTROSPECTION_GIRS:.gir=.typelib)
 CLEANFILES+= $(gir_DATA) $(typelib_DATA) $(BUILT_SOURCES)
 
 endif
-
-# We only do this check on Linux, so we don't have to worry about
-# different "nm" output on other platforms
-if OS_LINUX
-check-local:
-	@echo Checking libsoup-2.4.so symbols
-	@nm $(builddir)/.libs/libsoup-2.4.so | \
-		grep "^[[:xdigit:]]\+ [BGTRS] " | \
-		sed "s/^[[:xdigit:]]\+ [BGTRS] //" | \
-		env LC_ALL=C sort -u | \
-		diff -U0 $(srcdir)/libsoup-2.4.sym - >&2
-endif
diff --git a/libsoup/libsoup-2.4.sym b/libsoup/libsoup-2.4.sym
deleted file mode 100644
index e6ff89e..0000000
--- a/libsoup/libsoup-2.4.sym
+++ /dev/null
@@ -1,567 +0,0 @@
-_SOUP_METHOD_CONNECT
-_SOUP_METHOD_COPY
-_SOUP_METHOD_DELETE
-_SOUP_METHOD_GET
-_SOUP_METHOD_HEAD
-_SOUP_METHOD_LOCK
-_SOUP_METHOD_MKCOL
-_SOUP_METHOD_MOVE
-_SOUP_METHOD_OPTIONS
-_SOUP_METHOD_POST
-_SOUP_METHOD_PROPFIND
-_SOUP_METHOD_PROPPATCH
-_SOUP_METHOD_PUT
-_SOUP_METHOD_TRACE
-_SOUP_METHOD_UNLOCK
-_SOUP_URI_SCHEME_DATA
-_SOUP_URI_SCHEME_FILE
-_SOUP_URI_SCHEME_FTP
-_SOUP_URI_SCHEME_HTTP
-_SOUP_URI_SCHEME_HTTPS
-_SOUP_URI_SCHEME_RESOURCE
-_SOUP_URI_SCHEME_WS
-_SOUP_URI_SCHEME_WSS
-soup_add_completion
-soup_add_idle
-soup_add_io_watch
-soup_add_timeout
-soup_address_equal_by_ip
-soup_address_equal_by_name
-soup_address_family_get_type
-soup_address_get_gsockaddr
-soup_address_get_name
-soup_address_get_physical
-soup_address_get_port
-soup_address_get_sockaddr
-soup_address_get_type
-soup_address_hash_by_ip
-soup_address_hash_by_name
-soup_address_is_resolved
-soup_address_new
-soup_address_new_any
-soup_address_new_from_sockaddr
-soup_address_resolve_async
-soup_address_resolve_sync
-soup_auth_authenticate
-soup_auth_basic_get_type
-soup_auth_digest_get_type
-soup_auth_domain_accepts
-soup_auth_domain_add_path
-soup_auth_domain_basic_get_type
-soup_auth_domain_basic_new
-soup_auth_domain_basic_set_auth_callback
-soup_auth_domain_challenge
-soup_auth_domain_check_password
-soup_auth_domain_covers
-soup_auth_domain_digest_encode_password
-soup_auth_domain_digest_get_type
-soup_auth_domain_digest_new
-soup_auth_domain_digest_set_auth_callback
-soup_auth_domain_get_realm
-soup_auth_domain_get_type
-soup_auth_domain_remove_path
-soup_auth_domain_set_filter
-soup_auth_domain_set_generic_auth_callback
-soup_auth_domain_try_generic_auth_callback
-soup_auth_free_protection_space
-soup_auth_get_authorization
-soup_auth_get_host
-soup_auth_get_info
-soup_auth_get_protection_space
-soup_auth_get_realm
-soup_auth_get_saved_password
-soup_auth_get_saved_users
-soup_auth_get_scheme_name
-soup_auth_get_type
-soup_auth_has_saved_password
-soup_auth_is_authenticated
-soup_auth_is_for_proxy
-soup_auth_is_ready
-soup_auth_manager_get_type
-soup_auth_manager_use_auth
-soup_auth_new
-soup_auth_ntlm_get_type
-soup_auth_save_password
-soup_auth_update
-soup_buffer_copy
-soup_buffer_free
-soup_buffer_get_as_bytes
-soup_buffer_get_data
-soup_buffer_get_owner
-soup_buffer_get_type
-soup_buffer_new
-soup_buffer_new_subbuffer
-soup_buffer_new_take
-soup_buffer_new_with_owner
-soup_byte_array_get_type
-soup_cache_clear
-soup_cache_dump
-soup_cache_flush
-soup_cache_get_max_size
-soup_cache_get_type
-soup_cache_load
-soup_cache_new
-soup_cache_response_get_type
-soup_cache_set_max_size
-soup_cache_type_get_type
-soup_cacheability_get_type
-soup_char_attributes
-soup_check_version
-soup_client_context_get_address
-soup_client_context_get_auth_domain
-soup_client_context_get_auth_user
-soup_client_context_get_gsocket
-soup_client_context_get_host
-soup_client_context_get_local_address
-soup_client_context_get_remote_address
-soup_client_context_get_socket
-soup_client_context_get_type
-soup_client_context_steal_connection
-soup_connection_state_get_type
-soup_content_decoder_get_type
-soup_content_sniffer_get_buffer_size
-soup_content_sniffer_get_type
-soup_content_sniffer_new
-soup_content_sniffer_sniff
-soup_cookie_applies_to_uri
-soup_cookie_copy
-soup_cookie_domain_matches
-soup_cookie_equal
-soup_cookie_free
-soup_cookie_get_domain
-soup_cookie_get_expires
-soup_cookie_get_http_only
-soup_cookie_get_name
-soup_cookie_get_path
-soup_cookie_get_secure
-soup_cookie_get_type
-soup_cookie_get_value
-soup_cookie_jar_accept_policy_get_type
-soup_cookie_jar_add_cookie
-soup_cookie_jar_add_cookie_with_first_party
-soup_cookie_jar_all_cookies
-soup_cookie_jar_db_get_type
-soup_cookie_jar_db_new
-soup_cookie_jar_delete_cookie
-soup_cookie_jar_get_accept_policy
-soup_cookie_jar_get_cookie_list
-soup_cookie_jar_get_cookies
-soup_cookie_jar_get_type
-soup_cookie_jar_is_persistent
-soup_cookie_jar_new
-soup_cookie_jar_save
-soup_cookie_jar_set_accept_policy
-soup_cookie_jar_set_cookie
-soup_cookie_jar_set_cookie_with_first_party
-soup_cookie_jar_text_get_type
-soup_cookie_jar_text_new
-soup_cookie_new
-soup_cookie_parse
-soup_cookie_set_domain
-soup_cookie_set_expires
-soup_cookie_set_http_only
-soup_cookie_set_max_age
-soup_cookie_set_name
-soup_cookie_set_path
-soup_cookie_set_secure
-soup_cookie_set_value
-soup_cookie_to_cookie_header
-soup_cookie_to_set_cookie_header
-soup_cookies_free
-soup_cookies_from_request
-soup_cookies_from_response
-soup_cookies_to_cookie_header
-soup_cookies_to_request
-soup_cookies_to_response
-soup_date_copy
-soup_date_format_get_type
-soup_date_free
-soup_date_get_day
-soup_date_get_hour
-soup_date_get_minute
-soup_date_get_month
-soup_date_get_offset
-soup_date_get_second
-soup_date_get_type
-soup_date_get_utc
-soup_date_get_year
-soup_date_is_past
-soup_date_new
-soup_date_new_from_now
-soup_date_new_from_string
-soup_date_new_from_time_t
-soup_date_to_string
-soup_date_to_time_t
-soup_date_to_timeval
-soup_encoding_get_type
-soup_expectation_get_type
-soup_form_decode
-soup_form_decode_multipart
-soup_form_encode
-soup_form_encode_datalist
-soup_form_encode_hash
-soup_form_encode_valist
-soup_form_request_new
-soup_form_request_new_from_datalist
-soup_form_request_new_from_hash
-soup_form_request_new_from_multipart
-soup_get_major_version
-soup_get_micro_version
-soup_get_minor_version
-soup_header_contains
-soup_header_free_list
-soup_header_free_param_list
-soup_header_g_string_append_param
-soup_header_g_string_append_param_quoted
-soup_header_parse_list
-soup_header_parse_param_list
-soup_header_parse_quality_list
-soup_header_parse_semi_param_list
-soup_headers_parse
-soup_headers_parse_request
-soup_headers_parse_response
-soup_headers_parse_status_line
-soup_http_error_quark
-soup_http_version_get_type
-soup_known_status_code_get_type
-soup_logger_attach
-soup_logger_detach
-soup_logger_get_type
-soup_logger_log_level_get_type
-soup_logger_new
-soup_logger_set_printer
-soup_logger_set_request_filter
-soup_logger_set_response_filter
-soup_memory_use_get_type
-soup_message_add_header_handler
-soup_message_add_status_code_handler
-soup_message_body_append
-soup_message_body_append_buffer
-soup_message_body_append_take
-soup_message_body_complete
-soup_message_body_flatten
-soup_message_body_free
-soup_message_body_get_accumulate
-soup_message_body_get_chunk
-soup_message_body_get_type
-soup_message_body_got_chunk
-soup_message_body_new
-soup_message_body_set_accumulate
-soup_message_body_truncate
-soup_message_body_wrote_chunk
-soup_message_content_sniffed
-soup_message_disable_feature
-soup_message_finished
-soup_message_flags_get_type
-soup_message_get_address
-soup_message_get_first_party
-soup_message_get_flags
-soup_message_get_http_version
-soup_message_get_https_status
-soup_message_get_priority
-soup_message_get_soup_request
-soup_message_get_type
-soup_message_get_uri
-soup_message_got_body
-soup_message_got_chunk
-soup_message_got_headers
-soup_message_got_informational
-soup_message_headers_append
-soup_message_headers_clean_connection_headers
-soup_message_headers_clear
-soup_message_headers_foreach
-soup_message_headers_free
-soup_message_headers_free_ranges
-soup_message_headers_get
-soup_message_headers_get_content_disposition
-soup_message_headers_get_content_length
-soup_message_headers_get_content_range
-soup_message_headers_get_content_type
-soup_message_headers_get_encoding
-soup_message_headers_get_expectations
-soup_message_headers_get_headers_type
-soup_message_headers_get_list
-soup_message_headers_get_one
-soup_message_headers_get_ranges
-soup_message_headers_get_type
-soup_message_headers_header_contains
-soup_message_headers_header_equals
-soup_message_headers_iter_init
-soup_message_headers_iter_next
-soup_message_headers_new
-soup_message_headers_remove
-soup_message_headers_replace
-soup_message_headers_set_content_disposition
-soup_message_headers_set_content_length
-soup_message_headers_set_content_range
-soup_message_headers_set_content_type
-soup_message_headers_set_encoding
-soup_message_headers_set_expectations
-soup_message_headers_set_range
-soup_message_headers_set_ranges
-soup_message_headers_type_get_type
-soup_message_io_cleanup
-soup_message_is_keepalive
-soup_message_new
-soup_message_new_from_uri
-soup_message_priority_get_type
-soup_message_restarted
-soup_message_set_chunk_allocator
-soup_message_set_first_party
-soup_message_set_flags
-soup_message_set_http_version
-soup_message_set_priority
-soup_message_set_redirect
-soup_message_set_request
-soup_message_set_response
-soup_message_set_status
-soup_message_set_status_full
-soup_message_set_uri
-soup_message_starting
-soup_message_wrote_body
-soup_message_wrote_body_data
-soup_message_wrote_chunk
-soup_message_wrote_headers
-soup_message_wrote_informational
-soup_multipart_append_form_file
-soup_multipart_append_form_string
-soup_multipart_append_part
-soup_multipart_free
-soup_multipart_get_length
-soup_multipart_get_part
-soup_multipart_get_type
-soup_multipart_input_stream_get_headers
-soup_multipart_input_stream_get_type
-soup_multipart_input_stream_new
-soup_multipart_input_stream_next_part
-soup_multipart_input_stream_next_part_async
-soup_multipart_input_stream_next_part_finish
-soup_multipart_new
-soup_multipart_new_from_message
-soup_multipart_to_message
-soup_password_manager_get_passwords_async
-soup_password_manager_get_passwords_sync
-soup_password_manager_get_type
-soup_proxy_resolver_default_get_type
-soup_proxy_resolver_get_proxy_async
-soup_proxy_resolver_get_proxy_sync
-soup_proxy_resolver_get_type
-soup_proxy_uri_resolver_get_proxy_uri_async
-soup_proxy_uri_resolver_get_proxy_uri_sync
-soup_proxy_uri_resolver_get_type
-soup_request_data_get_type
-soup_request_error_get_type
-soup_request_error_quark
-soup_request_file_get_file
-soup_request_file_get_type
-soup_request_get_content_length
-soup_request_get_content_type
-soup_request_get_session
-soup_request_get_type
-soup_request_get_uri
-soup_request_http_get_message
-soup_request_http_get_type
-soup_request_send
-soup_request_send_async
-soup_request_send_finish
-soup_requester_error_get_type
-soup_requester_error_quark
-soup_requester_get_type
-soup_requester_new
-soup_requester_request
-soup_requester_request_uri
-soup_server_accept_iostream
-soup_server_add_auth_domain
-soup_server_add_early_handler
-soup_server_add_handler
-soup_server_add_websocket_handler
-soup_server_disconnect
-soup_server_get_async_context
-soup_server_get_listener
-soup_server_get_listeners
-soup_server_get_port
-soup_server_get_type
-soup_server_get_uris
-soup_server_is_https
-soup_server_listen
-soup_server_listen_all
-soup_server_listen_fd
-soup_server_listen_local
-soup_server_listen_options_get_type
-soup_server_listen_socket
-soup_server_new
-soup_server_pause_message
-soup_server_quit
-soup_server_remove_auth_domain
-soup_server_remove_handler
-soup_server_run
-soup_server_run_async
-soup_server_set_ssl_cert_file
-soup_server_unpause_message
-soup_session_abort
-soup_session_add_feature
-soup_session_add_feature_by_type
-soup_session_async_get_type
-soup_session_async_new
-soup_session_async_new_with_options
-soup_session_cancel_message
-soup_session_feature_add_feature
-soup_session_feature_attach
-soup_session_feature_detach
-soup_session_feature_get_type
-soup_session_feature_has_feature
-soup_session_feature_remove_feature
-soup_session_get_async_context
-soup_session_get_feature
-soup_session_get_feature_for_message
-soup_session_get_features
-soup_session_get_type
-soup_session_has_feature
-soup_session_new
-soup_session_new_with_options
-soup_session_pause_message
-soup_session_prefetch_dns
-soup_session_prepare_for_uri
-soup_session_queue_message
-soup_session_redirect_message
-soup_session_remove_feature
-soup_session_remove_feature_by_type
-soup_session_request
-soup_session_request_http
-soup_session_request_http_uri
-soup_session_request_uri
-soup_session_requeue_message
-soup_session_send
-soup_session_send_async
-soup_session_send_finish
-soup_session_send_message
-soup_session_steal_connection
-soup_session_sync_get_type
-soup_session_sync_new
-soup_session_sync_new_with_options
-soup_session_unpause_message
-soup_session_websocket_connect_async
-soup_session_websocket_connect_finish
-soup_session_would_redirect
-soup_socket_connect_async
-soup_socket_connect_sync
-soup_socket_disconnect
-soup_socket_get_fd
-soup_socket_get_local_address
-soup_socket_get_remote_address
-soup_socket_get_type
-soup_socket_io_status_get_type
-soup_socket_is_connected
-soup_socket_is_ssl
-soup_socket_listen
-soup_socket_new
-soup_socket_read
-soup_socket_read_until
-soup_socket_start_proxy_ssl
-soup_socket_start_ssl
-soup_socket_write
-soup_ssl_supported
-soup_status_get_phrase
-soup_status_get_type
-soup_status_proxify
-soup_str_case_equal
-soup_str_case_hash
-soup_tld_domain_is_public_suffix
-soup_tld_error_get_type
-soup_tld_error_quark
-soup_tld_get_base_domain
-soup_uri_copy
-soup_uri_copy_host
-soup_uri_decode
-soup_uri_encode
-soup_uri_equal
-soup_uri_free
-soup_uri_get_fragment
-soup_uri_get_host
-soup_uri_get_password
-soup_uri_get_path
-soup_uri_get_port
-soup_uri_get_query
-soup_uri_get_scheme
-soup_uri_get_type
-soup_uri_get_user
-soup_uri_host_equal
-soup_uri_host_hash
-soup_uri_new
-soup_uri_new_with_base
-soup_uri_normalize
-soup_uri_set_fragment
-soup_uri_set_host
-soup_uri_set_password
-soup_uri_set_path
-soup_uri_set_port
-soup_uri_set_query
-soup_uri_set_query_from_fields
-soup_uri_set_query_from_form
-soup_uri_set_scheme
-soup_uri_set_user
-soup_uri_to_string
-soup_uri_uses_default_port
-soup_value_array_append
-soup_value_array_append_vals
-soup_value_array_from_args
-soup_value_array_get_nth
-soup_value_array_insert
-soup_value_array_new
-soup_value_array_new_with_vals
-soup_value_array_to_args
-soup_value_hash_insert
-soup_value_hash_insert_vals
-soup_value_hash_insert_value
-soup_value_hash_lookup
-soup_value_hash_lookup_vals
-soup_value_hash_new
-soup_value_hash_new_with_vals
-soup_websocket_client_prepare_handshake
-soup_websocket_client_verify_handshake
-soup_websocket_close_code_get_type
-soup_websocket_connection_close
-soup_websocket_connection_get_close_code
-soup_websocket_connection_get_close_data
-soup_websocket_connection_get_connection_type
-soup_websocket_connection_get_io_stream
-soup_websocket_connection_get_origin
-soup_websocket_connection_get_protocol
-soup_websocket_connection_get_state
-soup_websocket_connection_get_type
-soup_websocket_connection_get_uri
-soup_websocket_connection_new
-soup_websocket_connection_send_binary
-soup_websocket_connection_send_text
-soup_websocket_connection_type_get_type
-soup_websocket_data_type_get_type
-soup_websocket_error_get_quark
-soup_websocket_error_get_type
-soup_websocket_server_check_handshake
-soup_websocket_server_process_handshake
-soup_websocket_state_get_type
-soup_xmlrpc_build_fault
-soup_xmlrpc_build_method_call
-soup_xmlrpc_build_method_response
-soup_xmlrpc_build_request
-soup_xmlrpc_build_response
-soup_xmlrpc_error_get_type
-soup_xmlrpc_error_quark
-soup_xmlrpc_extract_method_call
-soup_xmlrpc_extract_method_response
-soup_xmlrpc_fault_get_type
-soup_xmlrpc_fault_quark
-soup_xmlrpc_message_new
-soup_xmlrpc_message_set_fault
-soup_xmlrpc_message_set_response
-soup_xmlrpc_params_free
-soup_xmlrpc_params_parse
-soup_xmlrpc_parse_method_call
-soup_xmlrpc_parse_method_response
-soup_xmlrpc_parse_request
-soup_xmlrpc_parse_response
-soup_xmlrpc_request_new
-soup_xmlrpc_set_fault
-soup_xmlrpc_set_response
-soup_xmlrpc_variant_get_datetime
-soup_xmlrpc_variant_new_datetime
diff --git a/libsoup/libsoup-gnome-2.4.sym b/libsoup/libsoup-gnome-2.4.sym
deleted file mode 100644
index 67f62de..0000000
--- a/libsoup/libsoup-gnome-2.4.sym
+++ /dev/null
@@ -1,5 +0,0 @@
-soup_cookie_jar_sqlite_get_type
-soup_cookie_jar_sqlite_new
-soup_gnome_features_2_26_get_type
-soup_password_manager_gnome_get_type
-soup_proxy_resolver_gnome_get_type
-- 
2.5.0

