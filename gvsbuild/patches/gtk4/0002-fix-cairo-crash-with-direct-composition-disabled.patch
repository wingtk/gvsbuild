From f9e8061e33193f7069db8d4bd65a532ba658d05d Mon Sep 17 00:00:00 2001
From: Dan Yeaw <dan@yeaw.me>
Date: Sun, 23 Nov 2025 15:26:12 -0500
Subject: [PATCH] Windows: fix cairo crash with dcomp disabled

(cherry picked from commit f071763fd69e8924c497b9b21e43ef8e80718eff)
---
 gdk/win32/gdkcairocontext-win32.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/gdk/win32/gdkcairocontext-win32.c b/gdk/win32/gdkcairocontext-win32.c
index 37daf724726..dbd4929ee0f 100644
--- a/gdk/win32/gdkcairocontext-win32.c
+++ b/gdk/win32/gdkcairocontext-win32.c
@@ -134,8 +134,9 @@ gdk_win32_cairo_context_surface_detach (GdkDrawContext *context)
 {
   GdkWin32CairoContext *self = GDK_WIN32_CAIRO_CONTEXT (context);
   GdkSurface *surface = gdk_draw_context_get_surface (context);
+  GdkWin32Display *display = GDK_WIN32_DISPLAY (gdk_draw_context_get_display (context));

-  if (!GDK_SURFACE_DESTROYED (surface))
+  if (!GDK_SURFACE_DESTROYED (surface) && gdk_win32_display_get_dcomp_device (display))
     gdk_win32_surface_set_dcomp_content (GDK_WIN32_SURFACE (surface), NULL);

   gdk_win32_com_clear (&self->staging_texture);
--
GitLab
