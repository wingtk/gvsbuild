From d22b23388a12dc610d3288ee7c537b10bea9c87e Mon Sep 17 00:00:00 2001
From: Ignazio Pillai <ignazp@amazon.com>
Date: Fri, 28 Nov 2025 18:02:05 +0100
Subject: [PATCH] gtask: fix g_task_run_in_thread

Keep always an extra thread when cleaning up
to make sure that pending task can be started

Fixes: https://gitlab.gnome.org/GNOME/glib/-/issues/3840
Signed-off-by: Ignazio Pillai <ignazp@amazon.com>
---
 gio/gtask.c | 16 ++++++++--------
 1 file changed, 8 insertions(+), 8 deletions(-)

diff --git a/gio/gtask.c b/gio/gtask.c
index ef539cd54..1fbaa5845 100644
--- a/gio/gtask.c
+++ b/gio/gtask.c
@@ -1551,23 +1551,23 @@ static void
 g_task_thread_cleanup (void)
 {
   gint tasks_pending;
+  gint max_threads;
 
   g_mutex_lock (&task_pool_mutex);
   tasks_pending = g_thread_pool_unprocessed (task_pool);
 
-  if (tasks_running > G_TASK_POOL_SIZE)
-    {
-      g_thread_pool_set_max_threads (task_pool, tasks_running - 1, NULL);
-      g_trace_set_int64_counter (task_pool_max_counter, tasks_running - 1);
-    }
-  else if (tasks_running + tasks_pending < G_TASK_POOL_SIZE)
+  tasks_running--;
+
+  max_threads = MAX (G_TASK_POOL_SIZE, tasks_running + 1);
+  g_thread_pool_set_max_threads (task_pool, max_threads, NULL);
+  g_trace_set_int64_counter (task_pool_max_counter, max_threads);
+
+  if (tasks_running + tasks_pending < G_TASK_POOL_SIZE)
     g_source_set_ready_time (task_pool_manager, -1);
 
   if (tasks_running > G_TASK_POOL_SIZE && tasks_running < G_TASK_WAIT_TIME_MAX_POOL_SIZE)
     task_wait_time = (guint64) (task_wait_time / G_TASK_WAIT_TIME_MULTIPLIER);
 
-  tasks_running--;
-
   g_trace_set_int64_counter (tasks_running_counter, tasks_running);
 
   g_mutex_unlock (&task_pool_mutex);
-- 
2.51.0.windows.1

